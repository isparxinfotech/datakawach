<div class="container-fluid p-0 d-flex h-100">
  <app-dynamic-menus class="sidebar"></app-dynamic-menus>

  <div class="content-wrapper">
    <!-- Mobile Header -->
    <div class="d-md-none d-flex text-white bg-success align-items-center">
      <a href="dashboard" class="text-white" data-bs-toggle="offcanvas" data-bs-target="#bdSidebar">
        <i class="fa-solid fa-bars"></i>
      </a>
      <span>Data Kavach</span>
    </div>

    <div class="content-area">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="upload-card text-center">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <h3>Loading user data...</h3>
      </div>

      <!-- Main UI -->
      <div *ngIf="!isLoading" class="upload-card">
        <!-- Navbar -->
        <nav class="navbar">
          <a class="navbar-brand" href="dashboard">
            Welcome: {{ userSessionDetails?.username || 'Guest' }}
          </a>
        </nav>

        <hr>

        <!-- Upload Section -->
        <div *ngIf="userSessionDetails">
          <h2 class="card-title">Add Backup</h2>

          <!-- Backup Choice -->
          <div class="form-group">
            <label>Do you need a backup schedule?</label>
            <div class="d-flex gap-3">
              <label class="d-flex align-items-center">
                <input type="radio" [(ngModel)]="needsBackup" name="needsBackup" value="yes" (change)="onBackupChoiceChange()">
                <span>Yes, schedule backups</span>
              </label>
              <label class="d-flex align-items-center">
                <input type="radio" [(ngModel)]="needsBackup" name="needsBackup" value="no" (change)="onBackupChoiceChange()">
                <span>No, just upload files</span>
              </label>
            </div>
          </div>

          <!-- Form -->
          <form class="backup-form">
            <div class="form-group">
              <label>Username:</label>
              <input type="text" [value]="userSessionDetails.username" disabled>
            </div>

            <div class="form-group">
              <label>Select Folder:</label>
              <!-- Breadcrumbs -->
              <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="#" (click)="selectFolder('', $event)">Root</a></li>
                  <li *ngFor="let segment of folderPathSegments; let i = index" class="breadcrumb-item">
                    <a href="#" (click)="navigateToPathSegment(i, $event)">{{ segment }}</a>
                  </li>
                </ol>
              </nav>
              <!-- Tree View -->
              <div class="tree-view" *ngIf="!isLoadingFolders; else loadingFolders">
                <ul class="list-group">
                  <li *ngFor="let folder of currentFolders" class="list-group-item">
                    <div class="d-flex align-items-center">
                      <i class="fa-solid fa-folder me-2"></i>
                      <a href="#" (click)="toggleFolder(folder, $event)">{{ folder.name }}</a>
                      <button class="btn btn-sm btn-primary ms-auto" (click)="selectFolder(folder.path, $event)">Select</button>
                    </div>
                    <ul *ngIf="folder.isExpanded && folder.children?.length" class="list-group ms-4">
                      <li *ngFor="let subfolder of folder.children" class="list-group-item">
                        <div class="d-flex align-items-center">
                          <i class="fa-solid fa-folder me-2"></i>
                          <a href="#" (click)="toggleFolder(subfolder, $event)">{{ subfolder.name }}</a>
                          <button class="btn btn-sm btn-primary ms-auto" (click)="selectFolder(subfolder.path, $event)">Select</button>
                        </div>
                        <!-- Recursive Subfolder Display -->
                        <ul *ngIf="subfolder.isExpanded && subfolder.children?.length" class="list-group ms-4">
                          <li *ngFor="let subsubfolder of subfolder.children" class="list-group-item">
                            <div class="d-flex align-items-center">
                              <i class="fa-solid fa-folder me-2"></i>
                              <a href="#" (click)="toggleFolder(subsubfolder, $event)">{{ subsubfolder.name }}</a>
                              <button class="btn btn-sm btn-primary ms-auto" (click)="selectFolder(subsubfolder.path, $event)">Select</button>
                            </div>
                          </li>
                        </ul>
                      </li>
                    </ul>
                  </li>
                </ul>
                <p *ngIf="currentFolders.length === 0" class="text-muted">No folders available.</p>
              </div>
              <ng-template #loadingFolders>
                <div class="text-center">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading folders...</span>
                  </div>
                  <p>Loading folders...</p>
                </div>
              </ng-template>
            </div>

            <div class="form-group">
              <label>File Name:</label>
              <input type="text" [(ngModel)]="fileName" name="fileName" placeholder="e.g., myfile.txt" required (input)="validateFileNameInput()">
              <div *ngIf="fileNameError" class="error">{{ fileNameError }}</div>
            </div>

            <div *ngIf="needsBackup === 'yes'" class="form-group">
              <label>Local File/Folder Path:</label>
              <input type="text" [(ngModel)]="localPath" name="localPath" placeholder="e.g., C:\path\to\file">
            </div>

            <div *ngIf="needsBackup === 'yes'" class="form-group">
              <label>Backup Time (HH:mm):</label>
              <input type="time" [(ngModel)]="backupTime" name="backupTime">
            </div>

            <div *ngIf="needsBackup === 'yes'" class="form-group">
              <label>Retention Days:</label>
              <input type="number" [(ngModel)]="retentionDays" name="retentionDays" min="1" value="7">
            </div>

            <div *ngIf="needsBackup === 'yes'" class="form-group">
              <label>Backup Frequency:</label>
              <select [(ngModel)]="backupFrequency" name="backupFrequency" (change)="onFrequencyChange()">
                <option value="Daily">Daily</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
              </select>
            </div>

            <div *ngIf="needsBackup === 'yes' && backupFrequency === 'Weekly'" class="form-group">
              <label>Day of Week:</label>
              <select [(ngModel)]="dayOfWeek" name="dayOfWeek">
                <option value="MONDAY">Monday</option>
                <option value="TUESDAY">Tuesday</option>
                <option value="WEDNESDAY">Wednesday</option>
                <option value="THURSDAY">Thursday</option>
                <option value="FRIDAY">Friday</option>
                <option value="SATURDAY">Saturday</option>
                <option value="SUNDAY">Sunday</option>
              </select>
            </div>

            <div *ngIf="needsBackup === 'yes' && backupFrequency === 'Monthly'" class="form-group">
              <label>Day of Month:</label>
              <input type="number" [(ngModel)]="dayOfMonth" name="dayOfMonth" min="1" max="31">
            </div>

            <div class="form-group">
              <label>Select Files {{ needsBackup === 'yes' ? '(Optional)' : '(Required)' }}:</label>
              <input type="file" (change)="onFilesSelected($event)" name="fileInput" multiple>
              <small *ngIf="selectedFiles.length > 0" class="text-muted">Selected: {{ selectedFiles.length }} file(s)</small>
            </div>

            <!-- Buttons -->
            <div class="button-group">
              <button *ngIf="needsBackup === 'yes'" type="button" class="btn-primary" (click)="onCreateSchedule()" [disabled]="!isScheduleFormValid() || scheduling || fileNameError">
                {{ scheduling ? 'Creating Schedule...' : 'Create Backup Schedule' }}
              </button>
              <button type="button" class="btn-primary" (click)="onUpload()" [disabled]="!folderName || uploading || fileNameError || (needsBackup === 'no' && selectedFiles.length === 0)">
                {{ uploading ? 'Uploading...' : 'Upload Files' }}
              </button>
            </div>

            <!-- Progress -->
            <div *ngIf="overallProgress > 0" class="progress-container">
              <div class="progress-bar">
                <div class="progress" [style.width]="overallProgress + '%'">
                  Overall: {{ overallProgress }}% (File {{ currentFileIndex + 1 }} of {{ selectedFiles.length }})
                </div>
              </div>
            </div>

            <!-- Messages -->
            <div *ngIf="message" class="message" [ngClass]="{'success': isSuccess, 'error': !isSuccess}">
              <i [ngClass]="isSuccess ? 'fa-solid fa-check-circle' : 'fa-solid fa-exclamation-circle'"></i>
              {{ message }}
            </div>

            <!-- Backup List -->
            <div *ngIf="needsBackup === 'yes'" class="mt-4">
              <h3>Scheduled Backups</h3>
              <div *ngIf="isSchedulesLoading" class="text-center">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading schedules...</span>
                </div>
                <p>Loading backup schedules...</p>
              </div>
              <div *ngIf="!isSchedulesLoading" class="table-container">
                <table class="backup-table" *ngIf="backupSchedules.length > 0">
                  <thead>
                    <tr>
                      <th>Schedule ID</th>
                      <th>Path</th>
                      <th>Local Path</th>
                      <th>Frequency</th>
                      <th>Time</th>
                      <th>Retention Days</th>
                      <th>Last Backup</th>
                      <th>Next Run</th>
                      <th>Status</th>
                      <th>Action</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let schedule of backupSchedules; let i = index" [ngClass]="{'alternate-row': i % 2 === 1}">
                      <td>{{ schedule.scheduleId }}</td>
                      <td>{{ schedule.filePath }}</td>
                      <td>{{ schedule.localFilePath }}</td>
                      <td>
                        {{ schedule.backupFrequency }}
                        <span *ngIf="schedule.backupFrequency === 'Weekly'"> ({{ schedule.dayOfWeek }})</span>
                        <span *ngIf="schedule.backupFrequency === 'Monthly'"> (Day {{ schedule.dayOfMonth }})</span>
                      </td>
                      <td>{{ schedule.backupTime }}</td>
                      <td>{{ schedule.retentionDays }}</td>
                      <td>{{ schedule.lastBackupTime ? (schedule.lastBackupTime | date:'medium') : 'N/A' }}</td>
                      <td>{{ schedule.nextBackupTime | date:'medium' }}</td>
                      <td>{{ schedule.isActive ? 'Active' : 'Inactive' }}</td>
                      <td>
                        <button class="btn-action" (click)="triggerManualBackup(schedule.scheduleId)" [disabled]="!schedule.isActive">
                          Run Now
                        </button>
                      </td>
                    </tr>
                  </tbody>
                </table>
                <p *ngIf="backupSchedules.length === 0" class="no-data">
                  No backup schedules found. Create a new schedule above.
                </p>
              </div>
            </div>
          </form>
        </div>

        <!-- Fallback Message -->
        <div *ngIf="!userSessionDetails" class="error">
          No valid user session found. Please log in again.
        </div>
      </div>

      <!-- Success Modal -->
      <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="successModalLabel">Upload Successful</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              Your files have been uploaded successfully!
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>